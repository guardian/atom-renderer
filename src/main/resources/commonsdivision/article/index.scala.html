@import com.gu.contentatom.renderer.utils.GuardianDateFormatter
@import com.gu.contentatom.thrift.atom.commonsdivision.Mp

@(atom: com.gu.contentatom.thrift.Atom
, data: com.gu.contentatom.thrift.atom.commonsdivision.CommonsDivision
)

@partyClassName(name: String) = @{
  val shortName = name match {
    case "Conservative" => "tory"
    case "Labour" => "labour"
    case "Democratic Unionist Party" => "dup"
    case "Liberal Democrat" => "libdem"
    case "Green Party" => "green"
    case "Plaid Cymru" => "plaid"
    case "Scottish National Party" => "snp"
    case _ => "default"
  }
  s"atom--commonsdivision__party-$shortName"
}

@partyDisplayName(name: String) = @{
  name match {
    case "Democratic Unionist Party" => "DUP"
    case "Scottish National Party" => "SNP"
    case "Liberal Democrat" => "Lib Dem"
    case "Green Party" => "Green"
    case other => other
  }
}

@uniqueNames(a: Set[String], b: Set[String]) = @{ (a | b).toList.sorted }

@partyGrid(ayes: Map[String, Seq[Mp]], noes: Map[String, Seq[Mp]]) = {
  <div class="atom--commonsdivision__grid">
  @uniqueNames(ayes.keySet, noes.keySet).map { partyName =>
    <details class="atom--commonsdivision__party @partyClassName(partyName)">
      <summary>
        <div class="atom--commonsdivision__party-name">@partyDisplayName(partyName)</div>
        <div>@ayes.get(partyName).map(_.length).getOrElse("-")</div>
        <div>@noes.get(partyName).map(_.length).getOrElse("-")</div>
        <button class="atom__button atom--commonsdivision__party-handle atom--commonsdivision__party-handle">
          <span class="atom--commonsdivision__party-button is-on">
            @fragments.icons.html.plus()
          </span>
          <span class="atom--commonsdivision__party-button is-on">
            @fragments.icons.html.minus()
          </span>
        </button>
      </summary>
      <div class="atom--commonsdivision__mp-lists">
        <div></div>
        <div>
          <ul>@ayes.getOrElse(partyName, Nil).map { mp => <li>@mp.name</li>}</ul>
        </div>
        <div>
          <ul>@noes.getOrElse(partyName, Nil).map { mp => <li>@mp.name</li>}</ul>
        </div>
        <div></div>
      </div>
    </details>
  }
  </div>
}

@for(title <- atom.title; description <- data.description) {

  <details class="atom atom--snippet">
    <summary class="atom--snippet__header atom--commonsdivision__header">
      <span class="atom--snippet__label">Commons vote</span>
      <h4 class="atom--snippet__headline">'@Html(title)'</h4>
      <span class="atom--commonsdivision__description">@Html(description)</span>

      <div class="atom--commonsdivision__grid">
        <div class="atom--commonsdivision__count-header">
          <div>
            <time class="atom--commonsdivision__date" datetime="@{GuardianDateFormatter.toMachineValue(data.date)}">
              @GuardianDateFormatter.toCustomFormat(data.date, "dd MMMM yyyy")
            </time>
          </div>
          <div>Ayes</div>
          <div>Noes</div>
          <div></div>
        </div>
        <div class="atom--commonsdivision__count">
          <div>Total</div>
          <div>@data.votes.ayes.length</div>
          <div>@data.votes.noes.length</div>
          <div></div>
        </div>
      </div>

      <button class="atom__button atom__button--large atom__button--rounded atom--snippet__handle" aria-hidden="true">
        <span class="is-on">@{fragments.icons.html.plus()} Show parties</span>
        <span class="is-off">@{fragments.icons.html.minus()} Hide parties</span>
      </button>
    </summary>

    <div class="atom--snippet__body atom--commonsdivision__body">
      @{partyGrid(data.votes.ayes.groupBy(_.party), data.votes.noes.groupBy(_.party))}
    </div>
  </details>
}
